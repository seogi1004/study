<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="../lib/jquery-1.8.0.min.js"></script>
<script src="jui.chart.min.js"></script>
<script>
jui.define("chart.brush.vector", [ "util.math" ], function(_) {
    var VectorBrush = function() {

        this.createPoint = function(d, i) {
            var group = this.chart.svg.group();

            var circle = this.chart.svg.circle({
                fill: "#fff",
                r: 2
            });

            var text = this.chart.text({
                "font-size": 9,
                "text-anchor": "middle",
                fill: "#fff",
                y: -5
            }).text(d.name);

            group.append(circle);
            group.append(text);
            group.translate(this.axis.x(d.i), this.axis.y(d.j));

            return group;
        }

        this.createVector = function(d, i) {
            var group = this.chart.svg.group();

            var sx = this.axis.x(d.from[0]),
                sy = this.axis.y(d.from[1]),
                tx = this.axis.x(d.to[0]),
                ty = this.axis.y(d.to[1]),
                cx = (sx + tx) / 2,
                cy = (sy + ty) / 2,
                angle = _.degree(Math.atan2(d.to[1] - d.from[1], d.to[0] - d.from[0]));

            // 각도 보정
            if(angle < 0) angle += 360;

            var line = this.chart.svg.line({
                "marker-end": "url(#arrow_" + i + ")",
                stroke: this.color(i),
                "stroke-width": 1,
                x1: sx,
                y1: sy,
                x2: tx,
                y2: ty
            });

            var text = this.chart.text({
                "font-size": 10,
                "text-anchor": "middle",
                fill: this.color(i),
                y: -3
            });

            text.text(d.to[2]);
            text.rotate(-angle);
            text.translate(cx, cy);

            var marker = this.chart.svg.marker({
                id: "arrow_" + i,
                markerWidth: "13",
                markerHeight: "13",
                refX: 9,
                refY: 6,
                orient: "auto"
            });

            var path = this.chart.svg.path({
                fill: this.color(i)
            })
            .MoveTo(2, 2)
            .LineTo(2, 11)
            .LineTo(10, 6)
            .LineTo(2, 2);

            marker.append(path);
            this.chart.appendDefs(marker);

            group.append(line);
            group.append(text);

            return group;
        }

        this.draw = function() {
            var g = this.chart.svg.group();

            if(this.axis.data.length == 2) {
                var points = this.axis.data[0],
                    vectors = this.axis.data[1];

                for (var i = 0; i < points.length; i++) {
                    g.append(this.createPoint(points[i], i));
                }

                for (var i = 0; i < vectors.length; i++) {
                    g.append(this.createVector(vectors[i], i));
                }
            }

            return g;
        }
    }

    return VectorBrush;
}, "chart.brush.core");

jui.define("util.vector", [], function() {
    var VectorUtil = function() {
        var cache = {},
            points = [],
            vectors = [];

        this.addPoint = function(obj) {
            obj.seq = points.length;

            cache[obj.name] = obj;
            points.push(obj);
        }

        this.setPoints = function(list) {
            for(var i = 0; i < list.length; i++) {
                this.addPoint(list[i]);
            }
        }

        this.addVector = function(obj) {
            if(!obj.i && !obj.j) {
                var start = cache[obj.start],
                    end = cache[obj.end];

                obj.i = ((end) ? end.i : 0) - ((start) ? start.i : 0);
                obj.j = ((end) ? end.j : 0) - ((start) ? start.j : 0);
            }

            obj.seq = vectors.length;

            cache[obj.name] = obj;
            vectors.push(obj);
        }

        this.reverseVector = function(name) {
            var target = cache[name];
            if(!target) return;

            var p = this.data(name, 0, 0);
            this.addVector({
                name: "-" + name,
                start: [ p.i, p.j ],
                end: target.start
            });
        }

        this.setVectors = function(list) {
            for(var i = 0; i < list.length; i++) {
                this.addVector(list[i]);
            }
        }

        this.data = function(start, i, j) {
            var d = cache[start];

            if(d.start != null) {
                return this.data(d.start, d.i + i, d.j + j);
            }

            return {
                i: d.i + i,
                j: d.j + j
            }
        }

        this.update = function() {
            var newData = [];

            for(var i = 0; i < vectors.length; i++) {
                var vector = vectors[i];

                var tmpData = {},
                    name = vector.name,
                    start = vector.start,
                    end = vector.end;

                if(start == null) {
                    tmpData.from = [ 0, 0 ];
                } else if(typeof(start) == "string") {
                    tmpData.from = [ cache[start].i, cache[start].j ];
                } else {
                    tmpData.from = start;
                }

                if(end == null) {
                    tmpData.to = [ tmpData.from[0] + vector.i, tmpData.from[1] + vector.j, name ];
                } else if(typeof(end) == "string") {
                    tmpData.to = [ cache[end].i, cache[end].j, name ];
                } else {
                    tmpData.to = end;
                }

                newData[i] = tmpData;
            }

            return [ points, newData ];
        }
    }

    return VectorUtil;
});

jui.ready([ "chart.builder", "util.math", "util.vector" ], function(builder, _, VectorUtil) {
    var domain = [ -10, 10 ];

    var c = builder("#chart", {
        theme: "dark",
        padding: {
            top: 40,
            bottom: 20,
            left: 20,
            right: 20
        },
        width: 500,
        height: 500,
        axis: [{
            x: {
                type: "range",
                domain: domain,
                unit: 1,
                line: "solid"
            },
            y: {
                type: "range",
                domain: domain,
                unit: 1,
                line: "solid"
            }
        }],
        brush: [{
            type: "vector"
        }],
        style: {
            gridXAxisBorderWidth: 1,
            gridYAxisBorderWidth: 1,
            gridTickBorderSize: 0,
            gridXFontSize: 9,
            gridYFontSize: 9
        }
    });

    var vu = new VectorUtil();

    /*/
    vu.append({ name: "A", start: null, i: 5, j: 7 });
    vu.append({ name: "B", start: null, i: 6, j: 2 });
    vu.append({ name: "R", start: "A", end: "B" });
    vu.split("-P", "3:1", {
        start: "A",
        end: "B"
    }, "3:1");
    /**/

    /*/
    vu.append({ name: "A", start: null, i: -2, j: 2 });
    vu.append({ name: "B", start: null, i: -4, j: -2 });
    vu.append({ name: "C", start: null, i: 2, j: -2 });
    vu.append({ name: "D", start: null, i: 4, j: 2 });

    vu.sum("AB",{
        start: "-A",
        end: "B"
    });
    vu.sum("DA", {
        start: "B",
        end: "A",
        origin: "D"
    });
    vu.sum("BC", {
        start: "-A",
        end: "-B"
    });
    vu.sum("CD", {
        start: "A",
        end: "-B",
        origin: "C"
    });
    /**/

    /*/
    vu.append({ name: "A", start: null, i: 7, j: 0 });
    vu.append({ name: "B", start: null, i: 2, j: 3 });
    vu.append({ name: "C", start: null, i: 0, j: -(Math.sqrt(Math.pow(2, 2) + Math.pow(3, 2))) });
    vu.append({ name: "D", start: "C", i: 2, j: 3 });
    vu.append({ name: "E", start: "D", i: 7, j: 0 });

    vu.sum("A+B", {
        start: "A",
        end: "B"
    });
    vu.sum("A+B+C", {
        start: "A+B",
        end: "C"
    });
    /**/

    vu.setPoints([
        { name: "A", i: 3, j: 5 },
        { name: "B", i: 5, j: 4 },
    ]);

    vu.setVectors([
        { name: "a", start: null, end: "A" },
        { name: "b", start: "A", end: "B" },
        { name: "c", start: "B", i: 3, j: 1 }
    ]);

    vu.reverseVector("c");

    c.axis(0).update(vu.update());
});
</script>
</head>

<body>
<div id="chart"></div>
</body>
</html>