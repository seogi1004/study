<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="../lib/jquery-1.8.0.min.js"></script>
<script src="jui.chart.min.js"></script>
<script>
jui.define("chart.brush.vector", [ "util.math" ], function(_) {
    var VectorBrush = function() {
        this.draw = function() {
            var g = this.chart.svg.group();

            this.eachData(function(i, d) {
                var sx = this.axis.x(d.from[0]),
                    sy = this.axis.y(d.from[1]),
                    tx = this.axis.x(d.to[0]),
                    ty = this.axis.y(d.to[1]),
                    cx = (sx + tx) / 2,
                    cy = (sy + ty) / 2,
                    angle = _.degree(Math.atan2(d.to[1] - d.from[1], d.to[0] - d.from[0]));

                // 각도 보정
                if(angle < 0) angle += 360;

                var line = this.chart.svg.line({
                    "marker-end": "url(#arrow_" + i + ")",
                    stroke: this.color(i),
                    "stroke-width": 1,
                    x1: sx,
                    y1: sy,
                    x2: tx,
                    y2: ty
                });

                var circle = this.chart.svg.circle({
                    fill: this.color(i),
                    r: 3,
                    cx: sx,
                    cy: sy
                });

                var text = this.chart.text({
                    "font-size": 10,
                    "text-anchor": "middle",
                    fill: this.color(i),
                    y: -3
                });

                text.text(d.to[2]);
                text.rotate(-angle);
                text.translate(cx, cy);

                var marker = this.chart.svg.marker({
                    id: "arrow_" + i,
                    markerWidth: "13",
                    markerHeight: "13",
                    refX: 9,
                    refY: 6,
                    orient: "auto"
                });

                var path = this.chart.svg.path({
                    fill: this.color(i)
                })
                .MoveTo(2, 2)
                .LineTo(2, 11)
                .LineTo(10, 6)
                .LineTo(2, 2);

                marker.append(path);
                this.chart.appendDefs(marker);

                g.append(line);
                g.append(circle);
                g.append(text);
            });

            return g;
        }
    }

    return VectorBrush;
}, "chart.brush.core");

jui.define("util.vector", [], function() {
    var VectorUtil = function() {
        var cache = {},
            data = [];

        this.index = function(name) {
            for(var i = 0; i < data.length; i++) {
                if(data[i].name == name) {
                    return i;
                }
            }
        }

        this.append = function(d) {
            cache[d.name] = d;
            data.push(d);
        }

        this.point = function(start, i, j) {
            var d = cache[start];

            if(d.start != null) {
                return this.point(d.start, d.i + i, d.j + j);
            }

            return {
                i: d.i + i,
                j: d.j + j
            }
        }

        this.run = function() {
            var newData = [];

            for(var i = 0; i < data.length; i++) {
                var name = data[i].name,
                    start = data[i].start,
                    end = data[i].end;

                newData[i] = {};

                if(start == null) {
                    newData[i].from = [ 0, 0, "O" ];
                } else if(typeof(start) == "string") {
                    var p = this.point(start, 0, 0);
                    newData[i].from = [ p.i, p.j, start ];
                }

                if(end == null) {
                    newData[i].to = [newData[i].from[0] + data[i].i, newData[i].from[1] + data[i].j, name];
                } else {
                    var p = this.point(end, 0, 0);
                    newData[i].to = [p.i, p.j, name];
                }
            }

            return newData;
        }

        this.calculate = function(type, d) {
            var from = data[this.index(d.start)],
                to = data[this.index(d.end)];

            if(type == "+") {
                this.append({
                    name: d.name,
                    start: from.start,
                    i: from.i + to.i,
                    j: from.j + to.j
                });
            } else if(type == "-") {
                this.append({
                    name: d.name,
                    start: d.to,
                    i: from.i + (-to.i),
                    j: from.j + (-to.j)
                });
            } else if(type == "inner") {
                var rates = arguments[2].split(":"),
                    m = parseInt(rates[0]),
                    n = parseInt(rates[1]);

                this.append({
                    name: d.name,
                    start: null,
                    i: ((m * to.i) + (n * from.i)) / (m + n),
                    j: ((m * to.j) + (n * from.j)) / (m + n)
                });
            } else if(type == "outer") {
                var rates = arguments[2].split(":"),
                    m = parseInt(rates[0]),
                    n = parseInt(rates[1]);

                this.append({
                    name: d.name,
                    start: null,
                    i: ((m * to.i) - (n * from.i)) / (m - n),
                    j: ((m * to.j) - (n * from.j)) / (m - n)
                });
            }
        }
    }

    return VectorUtil;
});

jui.ready([ "chart.builder", "util.math", "util.vector" ], function(builder, _, VectorUtil) {
    var domain = [ -10, 10 ];

    var c = builder("#chart", {
        theme: "dark",
        padding: {
            top: 40,
            bottom: 20,
            left: 20,
            right: 20
        },
        width: 500,
        height: 500,
        axis: [{
            x: {
                type: "range",
                domain: domain,
                unit: 1,
                line: "solid"
            },
            y: {
                type: "range",
                domain: domain,
                unit: 1,
                line: "solid"
            }
        }],
        brush: [{
            type: "vector"
        }],
        style: {
            gridXAxisBorderWidth: 1,
            gridYAxisBorderWidth: 1,
            gridTickBorderSize: 0,
            gridXFontSize: 9,
            gridYFontSize: 9
        }
    });

    var vu = new VectorUtil();
    /*/
    vu.append({ name: "A", start: null, i: -1, j: 2 });
    vu.append({ name: "B", start: "A", i: 4, j: 0 });
    vu.calculate("+", {
        name: "C", start: "A", end: "B"
    });
    /**/

    /*/
    vu.append({ name: "A", start: null, i: -2, j: 4 });
    vu.append({ name: "B", start: null, i: 2, j: 1 });
    vu.calculate("-", {
        name: "C", start: "A", end: "B"
    });
    /**/

    /**/
    vu.append({ name: "A", start: null, i: 5, j: 7 });
    vu.append({ name: "B", start: null, i: 6, j: 2 });
    vu.append({ name: "C", start: "A", end: "B" });
    vu.calculate("inner", {
        name: "P", start: "A", end: "B"
    }, "3:1");
    /**/

    /*/
    vu.append({ name: "A", start: null, i: 5, j: 7 });
    vu.append({ name: "B", start: null, i: 6, j: 2 });
    vu.calculate("outer", {
        name: "P", start: "A", end: "B"
    }, "2:1");
    /**/

    c.axis(0).update(vu.run());
});
</script>
</head>

<body>
<div id="chart"></div>
</body>
</html>