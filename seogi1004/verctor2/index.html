<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="../lib/jquery-1.8.0.min.js"></script>
<script src="jui.chart.min.js"></script>
<script>
jui.define("chart.brush.vector", [ "util.math" ], function(_) {
    var VectorBrush = function() {
        this.draw = function() {
            var g = this.chart.svg.group();

            this.eachData(function(i, d) {
                var sx = this.axis.x(d.from[0]),
                    sy = this.axis.y(d.from[1]),
                    tx = this.axis.x(d.to[0]),
                    ty = this.axis.y(d.to[1]),
                    cx = (sx + tx) / 2,
                    cy = (sy + ty) / 2,
                    angle = _.degree(Math.atan2(d.to[1] - d.from[1], d.to[0] - d.from[0]));

                // 각도 보정
                if(angle < 0) angle += 360;

                var line = this.chart.svg.line({
                    "marker-end": "url(#arrow_" + i + ")",
                    stroke: this.color(i),
                    "stroke-width": 1,
                    x1: sx,
                    y1: sy,
                    x2: tx,
                    y2: ty
                });

                var circle = this.chart.svg.circle({
                    fill: this.color(i),
                    r: 3,
                    cx: sx,
                    cy: sy
                });

                var text = this.chart.text({
                    "font-size": 10,
                    "text-anchor": "middle",
                    fill: this.color(i),
                    y: -3
                });

                text.text(d.from[2] + d.to[2]);
                text.rotate(-angle);
                text.translate(cx, cy);

                var marker = this.chart.svg.marker({
                    id: "arrow_" + i,
                    markerWidth: "13",
                    markerHeight: "13",
                    refX: 9,
                    refY: 6,
                    orient: "auto"
                });

                var path = this.chart.svg.path({
                    fill: this.color(i)
                })
                .MoveTo(2, 2)
                .LineTo(2, 11)
                .LineTo(10, 6)
                .LineTo(2, 2);

                marker.append(path);
                this.chart.appendDefs(marker);

                g.append(line);
                g.append(circle);
                g.append(text);
            });

            return g;
        }
    }

    return VectorBrush;
}, "chart.brush.core");


/*/
 data: [
 { from: [ 0, 0, "O" ], to: [ 3, 8, "A" ] },
 { from: [ 3, 8, "A" ], to: [ -7, -3, "B" ] },
 { from: [ 3, 3, "C" ], to: [ 10, 5, "D" ] }
 ]
 /**/
jui.define("util.vector", [], function() {
    var VectorUtil = function() {
        var cache = {},
            data = [];

        this.index = function(name) {
            for(var i = 0; i < data.length; i++) {
                if(data[i].name == name) {
                    return i;
                }
            }
        }

        this.append = function(d) {
            cache[d.name] = d;
            data.push(d);
        }

        this.point = function(start, i, j) {
            var d = cache[start];

            if(d.start != null) {
                return this.point(d.start, d.i + i, d.j + j);
            }

            return {
                i: d.i + i,
                j: d.j + j
            }
        }

        this.run = function() {
            var newData = [];

            for(var i = 0; i < data.length; i++) {
                var name = data[i].name,
                    start = data[i].start;

                newData[i] = {};

                if(start == null) {
                    newData[i].from = [ 0, 0, "O" ];
                } else if(typeof(start) == "string") {
                    var p = this.point(start, 0, 0);
                    newData[i].from = [ p.i, p.j, start ];
                }

                newData[i].to = [ newData[i].from[0] + data[i].i, newData[i].from[1] + data[i].j, name ];
            }

            return newData;
        }

        this.calculate = function(type, d) {
            if(type == "+") {
                var x = 0,
                    y = 0;

                for(var i = 0; i < d.list.length; i++) {
                    var toName = d.list[i],
                        toData = data[this.index(toName)];

                    x += toData.i;
                    y += toData.j;
                }

                this.append({
                    name: d.name,
                    start: cache[d.list[0]].start,
                    i: x,
                    j: y
                });
            }
        }
    }

    return VectorUtil;
});

jui.ready([ "chart.builder", "util.math", "util.vector" ], function(builder, _, VectorUtil) {
    var domain = [ -20, 20 ];

    var c = builder("#chart", {
        theme: "dark",
        padding: {
            top: 40,
            bottom: 20,
            left: 20,
            right: 20
        },
        width: 750,
        height: 750,
        axis: [{
            x: {
                type: "range",
                domain: domain,
                unit: 1,
                line: "solid"
            },
            y: {
                type: "range",
                domain: domain,
                unit: 1,
                line: "solid"
            }
        }],
        brush: [{
            type: "vector"
        }],
        style: {
            gridXAxisBorderWidth: 1,
            gridYAxisBorderWidth: 1,
            gridTickBorderSize: 0,
            gridXFontSize: 9,
            gridYFontSize: 9
        }
    });

    var vu = new VectorUtil();
    vu.append({ name: "A", start: null, i: 5, j: 5 });
    vu.append({ name: "B", start: "A", i: 3, j: -2 });
    vu.append({ name: "C", start: "B", i: 2, j: 2 });
    vu.calculate("+", {
        name: "D", list: [ "B", "C" ]
    });

    c.axis(0).update(vu.run());
});
</script>
</head>

<body>
<div id="chart"></div>
</body>
</html>