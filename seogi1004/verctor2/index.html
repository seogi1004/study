<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="../lib/jquery-1.8.0.min.js"></script>
<script src="jui.chart.min.js"></script>
<script>
jui.define("chart.brush.vector", [ "util.math" ], function(_) {
    var VectorBrush = function() {
        this.draw = function() {
            var g = this.chart.svg.group();

            this.eachData(function(i, d) {
                if(d.reverse) return;

                var sx = this.axis.x(d.from[0]),
                    sy = this.axis.y(d.from[1]),
                    tx = this.axis.x(d.to[0]),
                    ty = this.axis.y(d.to[1]),
                    cx = (sx + tx) / 2,
                    cy = (sy + ty) / 2,
                    angle = _.degree(Math.atan2(d.to[1] - d.from[1], d.to[0] - d.from[0]));

                // 각도 보정
                if(angle < 0) angle += 360;

                var line = this.chart.svg.line({
                    "marker-end": "url(#arrow_" + i + ")",
                    stroke: this.color(i),
                    "stroke-width": 1,
                    x1: sx,
                    y1: sy,
                    x2: tx,
                    y2: ty
                });

                var circle = this.chart.svg.circle({
                    fill: this.color(i),
                    r: 3,
                    cx: sx,
                    cy: sy
                });

                var text = this.chart.text({
                    "font-size": 10,
                    "text-anchor": "middle",
                    fill: this.color(i),
                    y: -3
                });

                text.text(d.to[2]);
                text.rotate(-angle);
                text.translate(cx, cy);

                var marker = this.chart.svg.marker({
                    id: "arrow_" + i,
                    markerWidth: "13",
                    markerHeight: "13",
                    refX: 9,
                    refY: 6,
                    orient: "auto"
                });

                var path = this.chart.svg.path({
                    fill: this.color(i)
                })
                .MoveTo(2, 2)
                .LineTo(2, 11)
                .LineTo(10, 6)
                .LineTo(2, 2);

                marker.append(path);
                this.chart.appendDefs(marker);

                g.append(line);
                g.append(circle);
                g.append(text);
            });

            return g;
        }
    }

    return VectorBrush;
}, "chart.brush.core");

jui.define("util.vector", [], function() {
    var VectorUtil = function() {
        var cache = {},
            data = [];

        this.index = function(name) {
            for(var i = 0; i < data.length; i++) {
                if(data[i].name == name) {
                    return i;
                }
            }
        }

        this.append = function(d) {
            cache[d.name] = d;
            data.push(d);
        }

        this.point = function(start, i, j) {
            var d = cache[start];

            if(d.start != null) {
                return this.point(d.start, d.i + i, d.j + j);
            }

            return {
                i: d.i + i,
                j: d.j + j
            }
        }

        this.run = function() {
            var newData = [];

            for(var i = 0; i < data.length; i++) {
                var name = data[i].name,
                    start = data[i].start,
                    end = data[i].end;

                newData[i] = { reverse: data[i].reverse };

                if(start == null) {
                    newData[i].from = [ 0, 0, "O" ];
                } else if(typeof(start) == "string") {
                    var p = this.point(start, 0, 0);
                    newData[i].from = [ p.i, p.j, start ];
                }

                if(end == null) {
                    newData[i].to = [newData[i].from[0] + data[i].i, newData[i].from[1] + data[i].j, name];
                } else {
                    var p = this.point(end, 0, 0);
                    newData[i].to = [p.i, p.j, name];
                }
            }

            return newData;
        }

        this.reverse = function(name) {
            var target = data[this.index(name)];
            if(!target) return;

            var p = this.point(name, 0, 0);
            this.append({ name: "-" + name, start: name, i: -p.i, j: -p.j });

            // reverse가 true일 경우, 그리지 않음
            target.reverse = true;
        }

        this.sum = function(name, obj) {
            var start = obj.start,
                end = obj.end,
                origin = obj.origin;

            if(start.indexOf("-") != -1 && !this.index(start)) {
                this.reverse(start.substr(1));
            }

            if(end.indexOf("-") != -1 && !this.index(end)) {
                origin = !origin ? end.substr(1) : origin;
                this.reverse(end.substr(1));
            }

            var from = data[this.index(start)],
                to = data[this.index(end)];

            this.append({
                name: name,
                start: origin || from.start,
                i: from.i + to.i,
                j: from.j + to.j
            });
        }

        this.split = function(name, rate, obj) {
            var start = obj.start,
                end = obj.end,
                inner = name.indexOf("-") != -1;

            var from = data[this.index(start)],
                to = data[this.index(end)];

            var rates = rate.split(":"),
                m = parseInt(rates[0]),
                n = parseInt(rates[1]);

            if(inner) {
                this.append({
                    name: name,
                    start: null,
                    i: ((m * to.i) + (n * from.i)) / (m + n),
                    j: ((m * to.j) + (n * from.j)) / (m + n)
                });
            } else {
                this.append({
                    name: name,
                    start: null,
                    i: ((m * to.i) - (n * from.i)) / (m - n),
                    j: ((m * to.j) - (n * from.j)) / (m - n)
                });
            }
        }
    }

    return VectorUtil;
});

jui.ready([ "chart.builder", "util.math", "util.vector" ], function(builder, _, VectorUtil) {
    var domain = [ -10, 10 ];

    var c = builder("#chart", {
        theme: "dark",
        padding: {
            top: 40,
            bottom: 20,
            left: 20,
            right: 20
        },
        width: 500,
        height: 500,
        axis: [{
            x: {
                type: "range",
                domain: domain,
                unit: 1,
                line: "solid"
            },
            y: {
                type: "range",
                domain: domain,
                unit: 1,
                line: "solid"
            }
        }],
        brush: [{
            type: "vector"
        }],
        style: {
            gridXAxisBorderWidth: 1,
            gridYAxisBorderWidth: 1,
            gridTickBorderSize: 0,
            gridXFontSize: 9,
            gridYFontSize: 9
        }
    });

    var vu = new VectorUtil();

    /*/
    vu.append({ name: "A", start: null, i: 5, j: 7 });
    vu.append({ name: "B", start: null, i: 6, j: 2 });
    vu.append({ name: "R", start: "A", end: "B" });
    vu.split("-P", "3:1", {
        start: "A",
        end: "B"
    }, "3:1");
    /**/

    /*/
    vu.append({ name: "A", start: null, i: -2, j: 2 });
    vu.append({ name: "B", start: null, i: -4, j: -2 });
    vu.append({ name: "C", start: null, i: 2, j: -2 });
    vu.append({ name: "D", start: null, i: 4, j: 2 });

    vu.sum("AB",{
        start: "-A",
        end: "B"
    });
    vu.sum("DA", {
        start: "B",
        end: "A",
        origin: "D"
    });
    vu.sum("BC", {
        start: "-A",
        end: "-B"
    });
    vu.sum("CD", {
        start: "A",
        end: "-B",
        origin: "C"
    });
    /**/

    vu.append({ name: "A", start: null, i: 7, j: 0 });
    vu.append({ name: "B", start: null, i: 2, j: 3 });
    vu.append({ name: "C", start: null, i: 0, j: -(Math.sqrt(Math.pow(2, 2) + Math.pow(3, 2))) });
    vu.append({ name: "D", start: "C", i: 2, j: 3 });
    vu.append({ name: "E", start: "D", i: 7, j: 0 });

    vu.sum("A+B", {
        start: "A",
        end: "B"
    });
    vu.sum("A+B+C", {
        start: "A+B",
        end: "C"
    });

    c.axis(0).update(vu.run());
});
</script>
</head>

<body>
<div id="chart"></div>
</body>
</html>