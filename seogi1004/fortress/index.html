<!DOCTYPE html>
<html>
<head>
<title>Pong</title>

<script src="lib/createjs-2015.05.21.min.js"></script>


<script>
function Main() {
    var canvas = document.getElementById("main"),
        stage = new createjs.Stage(canvas),
        stageHeight = 300,
        stageWidth = 600,
        blockWidth = 100,
        blockHeight = 140,
        characterHeight = 32,
        characterWidth = 31,
        KEYCODE_LEFT = 37,
        KEYCODE_RIGHT = 39,
        xVel = 5,
        yVel = 1,
        moveLeft = false,
        moveRight = false;
    var character,
        xy = { front: { x: 0, y: 0 }, back: { x: 0, y: 0} },
        grounds = [];

    window.grounds = grounds;

    function setup() {
        var ground = [
            new createjs.Bitmap("img/grassTile.png"),
            new createjs.Bitmap("img/grassTile2.png"),
            new createjs.Bitmap("img/grassTile3.png")
        ]

        for(var i = 0; i < 8; i++) {
            var tmp = ground[Math.floor(Math.random() * 3)].clone();
            tmp.x = i * blockWidth;
            tmp.y = stageHeight - blockHeight;

            grounds.push(tmp);
            stage.addChild(tmp);
        }

        character = new createjs.Bitmap("img/tank.gif");
        character.x = 0;
        character.y = 0;
        stage.addChild(character);

        createjs.Ticker.addEventListener("tick", tick);
        document.onkeydown = handleKeyDown;
        document.onkeyup = handleKeyUp;
    }

    function tick() {
        // 방향키에 의한 조작
        if(moveLeft) {
            if(character.scaleX < 0) {
                character.scaleX *= -1;
                character.x -= characterWidth;
            }

            character.x -= xVel;
            xy.front.x = character.x;
            xy.back.x = character.x + characterWidth;
            xy.front.y = getGroundY(xy.front.x);
            xy.back.y = getGroundY(xy.back.x);

            var gy = getGroundY(xy.front.x);
            if(gy) {
                character.y = gy;
                character.rotation = -(getTankAngle() + 90);
            }
        } else if(moveRight) {
            if(character.scaleX > 0) {
                character.scaleX *= -1;
                character.x += characterWidth;
            }

            character.x += xVel;
            xy.front.x = character.x;
            xy.back.x = character.x - characterWidth;
            xy.front.y = getGroundY(xy.front.x);
            xy.back.y = getGroundY(xy.back.x);

            var gy = getGroundY(xy.back.x);
            if(gy) {
                character.y = getGroundY(xy.front.x);
                character.rotation = -(getTankAngle() - 90);
            }
        }

        stage.update();
    }

    function hitTests(x, y) {
        var isHit = false;

        for(var i = 0; i < grounds.length; i++) {
            var tmp = grounds[i],
                tx = x - tmp.x,
                ty = y - tmp.y + characterHeight;

            if(tx > 0 && ty > 0) {
                if (tmp.hitTest(tx, ty)) {
                    isHit = true;
                    break;
                }
            }
        }

        return isHit;
    }

    function getGroundY(x) {
        for(var i = stageHeight - blockHeight - characterHeight; i < stageHeight; i += yVel) {
            if(hitTests(x, i)) {
                return i;
            }
        }
    }

    function handleKeyDown(e) {
        switch(e.keyCode) {
            case KEYCODE_LEFT:
                moveLeft = true;
                break;
            case KEYCODE_RIGHT:
                moveRight = true;
                break;
        }
    }

    function handleKeyUp(e) {
        switch(e.keyCode) {
            case KEYCODE_LEFT:
                moveLeft = false;
                break;
            case KEYCODE_RIGHT:
                moveRight = false;
                break;
        }
    }

    function getTankAngle() {
        var dx = xy.front.x - xy.back.x,
            dy = xy.front.y - xy.back.y;

        var rad = Math.atan2(dx, dy),
            degree = (rad * 180) / Math.PI;

        return degree;
    }

    setup();
}
</script>
</head>
<body onload="Main();">
    <canvas id="main" width="600" height="300"></canvas>
</body>
</html>