<!DOCTYPE html>
<html>
<head>
<title>Pong</title>

<script src="lib/createjs-2015.05.21.min.js"></script>


<script>
function Main() {
    var canvas = document.getElementById("main"),
        stage = new createjs.Stage(canvas),
        stageHeight = 300,
        stageWidth = 600,
        blockWidth = 100,
        blockHeight = 140,
        characterHeight = 32,
        characterWidth = 31,
        KEYCODE_LEFT = 37,
        KEYCODE_RIGHT = 39,
        xVel = 5,
        yVel = 1,
        moveLeft = false,
        moveRight = false;
    var character,
        grounds = [];

    window.grounds = grounds;

    function setup() {
        var ground = [
            new createjs.Bitmap("img/grassTile.png"),
            new createjs.Bitmap("img/grassTile2.png"),
            new createjs.Bitmap("img/grassTile3.png")
        ]

        for(var i = 0; i < 8; i++) {
            var tmp = ground[Math.floor(Math.random() * 3)].clone();
            tmp.x = i * blockWidth;
            tmp.y = stageHeight - blockHeight;

            grounds.push(tmp);
            stage.addChild(tmp);
        }

        character = new createjs.Bitmap("img/tank.png");
        character.x = Math.floor(Math.random() * (stageWidth - characterWidth));
        character.y = 0;
        stage.addChild(character);

        createjs.Ticker.addEventListener("tick", tick);
        document.onkeydown = handleKeyDown;
        document.onkeyup = handleKeyUp;
    }

    function tick() {
        var tx = 0;

        // 방향키에 의한 조작
        if(moveLeft) {
            character.x -= xVel;

            if(character.scaleX < 0) {
                character.scaleX *= -1;
                character.x -= characterWidth;
            }
        } else if(moveRight) {
            character.x += xVel;

            if(character.scaleX > 0) {
                character.scaleX *= -1;
                character.x += characterWidth;
            }

            tx = -characterWidth;
        }

        character.y = getGroundY(character.x + tx);
        stage.update();
    }

    function hitTests(x, y) {
        var isHit = false;

        for(var i = 0; i < grounds.length; i++) {
            var tmp = grounds[i],
                tx = x - tmp.x + characterWidth / 2,
                ty = y - tmp.y + characterHeight;

            if(tx > 0 && ty > 0) {
                if (tmp.hitTest(tx, ty)) {
                    isHit = true;
                    break;
                }
            }
        }

        return isHit;
    }

    function getGroundY(x) {
        for(var i = 0; i < stageHeight; i += yVel) {
            if(hitTests(x, i)) {
                return i;
            }
        }
    }

    function handleKeyDown(e) {
        switch(e.keyCode) {
            case KEYCODE_LEFT:
                moveLeft = true;
                break;
            case KEYCODE_RIGHT:
                moveRight = true;
                break;
        }
    }

    function handleKeyUp(e) {
        switch(e.keyCode) {
            case KEYCODE_LEFT:
                moveLeft = false;
                break;
            case KEYCODE_RIGHT:
                moveRight = false;
                break;
        }
    }

    setup();
}
</script>
</head>
<body onload="Main();">
    <canvas id="main" width="600" height="300"></canvas>
</body>
</html>