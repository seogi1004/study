<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="dist/jui.css" />
<link rel="stylesheet" href="dist/jennifer.theme.css" />
<script src="../lib/jquery-1.8.0.min.js"></script>
<script src="dist/jui.min.js"></script>
<style>
    .btn.active:not(.toggle) {
        color: #ffffff !important;
        border: 1px solid #9663f4 !important;
        -webkit-box-shadow: rgba(0, 0, 0, 0.3) 0 1px 5px inset, rgba(255, 255, 255, 0.2) 0 1px 0 !important;
        -moz-box-shadow: rgba(0, 0, 0, 0.3) 0 1px 5px inset, rgba(255, 255, 255, 0.2) 0 1px 0 !important;
        box-shadow: rgba(0, 0, 0, 0.3) 0 1px 5px inset, rgba(255, 255, 255, 0.2) 0 1px 0 !important;
        background-color: #9c74ea !important;
        background-image: -moz-linear-gradient(top, #a57ff2, #8f64de) !important;
        background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#a57ff2), to(#8f64de)) !important;
        background-image: -webkit-linear-gradient(top, #a57ff2, #8f64de) !important;
        background-image: -o-linear-gradient(top, #a57ff2, #8f64de) !important;
        background-image: linear-gradient(to bottom, #a57ff2, #8f64de) !important;
        background-repeat: repeat-x !important;
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffa57ff2', endColorstr='#ff8f64de', GradientType=0) !important;
    }

    #color_vector {
        position: absolute;
        right: 0px;
        z-index: 10000;
    }
</style>
<script>
var RANGE = [ -10, 10 ],
    SIZE = 10,
    BG_COLOR = "#00ba60",
    BG_OPACITY = 0.3,
    BR_COLOR = "#00ba60",
    BR_OPACITY = 1,
    FONT_SIZE = 13,
    FONT_COLOR = "#ffffff",
    LINE_COLOR = "#ffffff";

var NAMES = {
    "A": 4,
    "B": 7,
    "C": 6,
    "D": 5,
    "E": 0,
    "F": 3,
    "G": 2,
    "H": 1
};

var DATA = [];
DATA[NAMES["A"]] = { name: "A", vectors: [] };
DATA[NAMES["B"]] = { name: "B", vectors: [] };
DATA[NAMES["C"]] = { name: "C", vectors: [] };
DATA[NAMES["D"]] = { name: "D", vectors: [] };
DATA[NAMES["E"]] = { name: "E", vectors: [] };
DATA[NAMES["F"]] = { name: "F", vectors: [] };
DATA[NAMES["G"]] = { name: "G", vectors: [] };
DATA[NAMES["H"]] = { name: "H", vectors: [] };

var OPERATORS = [
    //{ type: "+", start: NAMES["B"], a: "BA", b: "BC", color: "red" },
    //{ type: "*", start: NAMES["F"], a: "FG", b: "FE", color: "blue" },
];

jui.define("chart.brush.vector3d", [ "util.base", "util.color", "chart.polygon.cube", "chart.polygon.point", "chart.vector" ],
        function(_, ColorUtil, CubePolygon, PointPolygon, Vector) {

    var Vector3DBrush = function() {
        var g, vectors = {};

        this.drawCube = function(p) {
            for(var i = 0; i < p.faces.length; i++) {
                var key = p.faces[i];

                var face = this.svg.polygon({
                    fill: BG_COLOR,
                    "fill-opacity": BG_OPACITY,
                    stroke: BR_COLOR,
                    "stroke-opacity": BR_OPACITY
                });

                for(var j = 0; j < key.length; j++) {
                    var vector = p.vectors[key[j]];
                    face.point(vector.x, vector.y);
                }

                g.append(face);
            }
        }

        this.drawTexts = function(p) {
            for(var i = 0; i < p.vectors.length; i++) {
                var text = this.chart.text({
                    "font-size": FONT_SIZE,
                    "text-anchor": "middle",
                    fill: FONT_COLOR,
                    x: -10
                });

                text.text(DATA[i].name);
                text.translate(p.vectors[i].x, p.vectors[i].y);

                g.append(text);
            }
        }

        this.drawMarker = function(id, color) {
            var marker = this.svg.marker({
                id: id,
                markerWidth: "13",
                markerHeight: "13",
                refX: 9,
                refY: 6,
                orient: "auto"
            });

            var path = this.svg.path({
                fill: color
            })
            .MoveTo(2, 2)
            .LineTo(2, 11)
            .LineTo(10, 6)
            .LineTo(2, 2);

            marker.append(path);
            this.chart.appendDefs(marker);
        }

        this.drawVectors = function(p) {
            for(var i = 0; i < p.vectors.length; i++) {
                var data = DATA[i],
                    vector = p.vectors[i];

                for(var j = 0; j < data.vectors.length; j++) {
                    var targetIndex = data.vectors[j],
                        targetData = DATA[targetIndex],
                        targetVector = p.vectors[targetIndex];

                    // 새로운 벡터 데이터 만들기
                    var newKey = data.name + targetData.name,
                        newVector = new Vector(targetVector.x - vector.x, targetVector.y - vector.y, targetVector.z - vector.z);

                    vectors[newKey] = {
                        name: newKey,
                        vector: newVector
                    };

                    var line = this.svg.line({
                        "marker-end": "url(#arrow)",
                        stroke: LINE_COLOR,
                        "stroke-width": 1,
                        "stroke-dasharray": "3,3",
                        x1: vector.x,
                        y1: vector.y,
                        x2: targetVector.x,
                        y2: targetVector.y
                    });

                    g.append(line);
                }
            }
        }

        this.drawNewVector = function(cmd, startVector, newVector) {
            var uuid = _.createId("arrow");

            this.drawMarker(uuid, cmd.color);

            var line = this.svg.line({
                "marker-end": "url(#" + uuid + ")",
                stroke: cmd.color,
                "stroke-width": 1,
                x1: startVector.x,
                y1: startVector.y,
                x2: startVector.x + newVector.x,
                y2: startVector.y + newVector.y
            });

            var text = this.chart.text({
                "font-size": FONT_SIZE,
                "text-anchor": "middle",
                fill: cmd.color,
                x: -10
            });

            text.text(cmd.a + cmd.type + cmd.b);
            text.translate(startVector.x + newVector.x/2, startVector.y + newVector.y/2);

            g.append(line);
            g.append(text);
        }

        this.drawOperators = function(p) {
            for(var i = 0; i < OPERATORS.length; i++) {
                var cmd = OPERATORS[i],
                    startVector = p.vectors[cmd.start],
                    aVector = vectors[cmd.a].vector,
                    bVector = vectors[cmd.b].vector,
                    newVector = null;

                if(cmd.type == "+") { // 덧셈
                    newVector = aVector.add(bVector);
                } else if(cmd.type == "-") { // 뺄셈
                    newVector = aVector.subtract(bVector);
                } else if(cmd.type == "*") { // 외적
                    newVector = aVector.crossProduct(bVector);
                }

                this.drawNewVector(cmd, startVector, newVector);
            }
        }

        this.drawBefore = function() {
            g = this.svg.group();
        }

        this.draw = function() {
            var x = this.axis.x(-SIZE/2),
                y = this.axis.y(-SIZE/2),
                z = this.axis.z(-SIZE/2),
                w = this.axis.x(SIZE/2) - x,
                h = this.axis.y(SIZE/2) - y,
                d = this.axis.z(SIZE/2) - z,
                p = new CubePolygon(x, y, z, w, h, d);

            // 3D 좌표 계산
            this.calculate3d(p);

            // 각각의 요소 그리기
            this.drawMarker("arrow", LINE_COLOR);
            this.drawCube(p);
            this.drawTexts(p);
            this.drawVectors(p);

            // 벡터 연산 그리기
            this.drawOperators(p);

            return g;
        }
    }

    return Vector3DBrush;

}, "chart.brush.core");

jui.ready([ "util.base", "chart.builder", "uix.window", "ui.combo", "uix.table", "ui.button", "ui.colorpicker" ],
        function(_, builder, win, combo, table, button, colorpicker) {

    window.chart = builder("#chart", {
        theme: "dark",
        padding: 100,
        width: 600,
        height: 600,
        axis: [{
            x: {
                type: "range",
                domain: RANGE,
                step: 4,
                hide: true
            },
            y: {
                type: "range",
                domain: RANGE,
                step: 4,
                hide: true
            },
            z: {
                type: "range",
                domain: RANGE,
                step: 4,
                reverse: true,
                hide: true
            },
            degree: {
                x: 30,
                y: 30
            },
            depth: 400,
            perspective: 1,
            data: DATA
        }],
        brush: {
            type: "vector3d"
        },
        widget: {
            type: "polygon.rotate"
        }
    });

    var target_vertex = combo("#target_vertex", { width: 50 });
    var start_vertex = combo("#start_vertex", { width: 50 });

    var start_vector = combo("#start_vector", { width: 60 });
    var end_vector = combo("#end_vector", { width: 60 });
    var tpl_vector_func = _.template($("#tpl_combo_vectors").html());

    window.select_vertex = button("#select_vertex", {
        type: "radio",
        event: {
            change: function(data) {
                reloadTable();
            }
        }
    });

    window.select_operator = button("#select_operator", {
        type: "radio",
        event: {
            change: function(data) {
                $("#span_operator").html(data.value);
            }
        }
    });

    window.v_table = table("#vectors", {
        fields: [ "key", null ],
        scroll: true,
        scrollHeight: 230,
        tpl: {
            row: $("#tpl_row").html(),
            none: $("#tpl_none").html()
        }
    });

    window.c_table = table("#operators", {
        fields: [ "start", "operator", null ],
        scroll: true,
        scrollHeight: 230,
        tpl: {
            row: $("#tpl_row2").html(),
            none: $("#tpl_none2").html()
        }
    });

    window.color_vector = colorpicker("#color_vector", {
        event: {
            change: function(color) {
                $("#color_vector_value").css("background", color).val(color);
            }
        }
    });

    $(color_vector.root).hide();

    window.win_add = win("#win_add", {
        width: 550,
        height: 450,
        modal: true
    });

    window.win_calc = win("#win_calc", {
        width: 550,
        height: 450,
        modal: true
    });

    $(win_calc.root).find(".body").on("mousedown", function(e) {
        if($(color_vector.root).css("display") == "block") {
            if(!$(e.target).hasClass("value") && !$(e.target).hasClass("container") &&  !$(e.target).hasClass("control") &&
            !$(e.target).hasClass("drag-bar") && !$(e.target).hasClass("drag-bar2")) {
                $(color_vector.root).hide();
                return false;
            }
        }
    });

    $("#color_vector_value").on("click", function(e) {
        $(color_vector.root).show();
        return false;
    });

    $("#btn_add").on("click", function(e) {
        win_add.show();
    });

    $("#btn_calc").on("click", function(e) {
        win_calc.show();

        $(start_vector.root).find("ul").html(tpl_vector_func());
        $(end_vector.root).find("ul").html(tpl_vector_func());

        start_vector.reload();
        end_vector.reload();
    });

    $("#btn_connect").on("click", function(e) {
        var btn = select_vertex.getValue(),
            combo = target_vertex.getValue();

        if(btn == combo) {
            alert("동일한 값은 추가할 수 없습니다.");
        } else {
            var list = DATA[NAMES[btn]].vectors;

            if($.inArray(NAMES[combo], list) == -1) {
                list.push(NAMES[combo]);
                reloadTable();
            } else {
                alert("이미 추가된 값입니다.");
            }
        }
    });

    $("#btn_operator").on("click", function(e) {
        var a = start_vector.getValue(),
            b = end_vector.getValue();

        if(a == b) {
            alert("동일한 벡터를 연산할 수 없습니다.");
        } else {
            var keys = getOperatorKeys(),
                obj = {
                    type: select_operator.getValue(),
                    start: NAMES[start_vertex.getValue()],
                    a: start_vector.getValue(),
                    b: end_vector.getValue(),
                    color: $("#color_vector_value").val()
                };

            if($.inArray(obj.a + obj.type + obj.b, keys) != -1) {
                alert("이미 존재하는 연산 벡터입니다.");
            } else {
                OPERATORS.push(obj);
                reloadTable2();
            }
        }
    });
});

function reloadTable2() {
    var list = [];

    for(var i = 0; i < OPERATORS.length; i++) {
        list.push({
            start: getValueToKey(OPERATORS[i].start),
            operator: OPERATORS[i].a + OPERATORS[i].type + OPERATORS[i].b,
            color: OPERATORS[i].color
        });
    }

    c_table.update(list);
    chart.axis(0).update(DATA);
}

function removeTable2(index) {
    var list = [];

    for(var i = 0; i < OPERATORS.length; i++) {
        if(i != index) {
            list.push(OPERATORS[i]);
        }
    }

    OPERATORS = list;
    reloadTable2();
}

function reloadTable() {
    var btn = select_vertex.getValue(),
        vectors = DATA[NAMES[btn]].vectors,
        data = [];

    for(var i = 0; i < vectors.length; i++) {
        for(var key in NAMES) {
            if(NAMES[key] == vectors[i]) {
                data.push({
                    key: key,
                    value: vectors[i]
                });
            }
        }
    }

    v_table.update(data);
    chart.axis(0).update(DATA);
}

function removeTable(value) {
    var btn = select_vertex.getValue(),
        vectors = DATA[NAMES[btn]].vectors,
        data = [];

    for(var i = 0; i < vectors.length; i++) {
        if(vectors[i] != value) {
            data.push(vectors[i]);
        }
    }

    DATA[NAMES[btn]].vectors = data;
    reloadTable();
}

function getVectors() {
    var keys = [];

    for(var i = 0; i < DATA.length; i++) {
        for(var j = 0; j < DATA[i].vectors.length; j++) {
            keys.push(DATA[i].name + getValueToKey(DATA[i].vectors[j]));
        }
    }

    return keys;
}

function getValueToKey(value) {
    for(var key in NAMES) {
        if(value == NAMES[key]) {
            return key;
        }
    }
}

function getOperatorKeys() {
    var list = [];

    for(var i = 0; i < OPERATORS.length; i++) {
        list.push(OPERATORS[i].a + OPERATORS[i].type + OPERATORS[i].b);
    }

    return list;
}
</script>
</head>

<body class="jui">
<div class="panel" style="width: 602px;">
    <div class="head">
        <div class="row">
            <div class="col col-6">
                <button id="btn_add" class="btn small">벡터 추가</button>
                <button id="btn_calc" class="btn small">벡터 연산</button>
            </div>
            <div class="col col-6" align="right">
            </div>
        </div>
    </div>
    <div class="body fit">
        <div id="chart"></div>
    </div>
</div>

<div id="win_add" class="window">
    <div class="head">
        <div class="left">벡터 추가</div>
        <div class="right">
            <a href="#" class="close"><i class="icon-exit"></i></a>
        </div>
    </div>
    <div class="body">
        <div class="row">
            <span>꼭지점</span>
            <div id="select_vertex" class="group">
                <a class="btn mini" value="A">A</a>
                <a class="btn mini" value="B">B</a>
                <a class="btn mini" value="C">C</a>
                <a class="btn mini" value="D">D</a>
                <a class="btn mini" value="E">E</a>
                <a class="btn mini" value="F">F</a>
                <a class="btn mini" value="G">G</a>
                <a class="btn mini" value="H">H</a>
            </div>
        </div>

        <div class="hr" style="margin-top: 10px;"></div>

        <div class="row" style="margin: 10px 0px 5px 0px; text-align: right;">
            <span>연결할 꼭지점</span>
            <div id="target_vertex" class="combo">
                <a class="btn small">...</a>
                <ul>
                    <li><a value="A">A</a></li>
                    <li><a value="B">B</a></li>
                    <li><a value="C">C</a></li>
                    <li><a value="D">D</a></li>
                    <li><a value="E">E</a></li>
                    <li><a value="F">F</a></li>
                    <li><a value="G">G</a></li>
                    <li><a value="H">H</a></li>
                </ul>
                <a class="btn small toggle"><i class="icon-arrow2"></i></a>
            </div>
            &nbsp;&nbsp;

            <button id="btn_connect" class="btn small focus">추가</button>
        </div>

        <table id="vectors" class="table simple mini headline">
            <thead>
                <tr>
                    <th>이름</th>
                    <th width="50px">삭제</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<div id="win_calc" class="window">
    <div class="head">
        <div class="left">벡터 연산</div>
        <div class="right">
            <a href="#" class="close"><i class="icon-exit"></i></a>
        </div>
    </div>
    <div class="body">
        <div class="row">
            <span>연산자</span>
            <div id="select_operator" class="group">
                <a class="btn mini" value="+">+</a>
                <a class="btn mini" value="-">-</a>
                <a class="btn mini" value="*">*</a>
            </div>
        </div>

        <div class="hr" style="margin-top: 10px;"></div>

        <div class="row" style="margin: 10px 0px 5px 0px;">
            <div class="col col-10">
                <span>시작 꼭지점</span>
                <div id="start_vertex" class="combo">
                    <a class="btn small">Select...</a>
                    <ul>
                        <li><a value="A">A</a></li>
                        <li><a value="B">B</a></li>
                        <li><a value="C">C</a></li>
                        <li><a value="D">D</a></li>
                        <li><a value="E">E</a></li>
                        <li><a value="F">F</a></li>
                        <li><a value="G">G</a></li>
                        <li><a value="H">H</a></li>
                    </ul>
                    <a class="btn small toggle"><i class="icon-arrow2"></i></a>
                </div>
                &nbsp;&nbsp;

                <span>연산 벡터</span>
                <div id="start_vector" class="combo">
                    <a class="btn small">...</a>
                    <ul></ul>
                    <a class="btn small toggle"><i class="icon-arrow2"></i></a>
                </div><span id="span_operator">+</span><div id="end_vector" class="combo">
                    <a class="btn small">...</a>
                    <ul></ul>
                    <a class="btn small toggle"><i class="icon-arrow2"></i></a>
                </div>

                &nbsp;&nbsp;
                <span>색상</span>
                <input id="color_vector_value" type="text" class="input small" style="width: 40px; background: #FF0000" value="#FF0000"/>
                <div id="color_vector" class="colorpicker"></div>
            </div>

            <div class="col col-2" align="right">
                <button id="btn_operator" class="btn small focus">추가</button>
            </div>
        </div>

        <table id="operators" class="table simple mini headline">
            <thead>
            <tr>
                <th>시작 꼭지점</th>
                <th>연산 벡터</th>
                <th width="50px">삭제</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<script id="tpl_row" type="text/template">
<tr>
    <td><!= key !></td>
    <td><button onclick="removeTable(<!= value !>)" class="btn mini"><i class="icon-close"></i></button></td>
</tr>
</script>

<script id="tpl_none" type="text/template">
    <tr>
        <td colspan="2" align="center">연결된 벡터가 없습니다.</td>
    </tr>
</script>

<script id="tpl_row2" type="text/template">
    <tr>
        <td style="color: <!= color !> !important;"><!= start !></td>
        <td style="color: <!= color !> !important;"><!= operator !></td>
        <td><button onclick="removeTable2(<!= row.index !>)" class="btn mini"><i class="icon-close"></i></button></td>
    </tr>
</script>

<script id="tpl_none2" type="text/template">
    <tr>
        <td colspan="3" align="center">연산 벡터가 없습니다.</td>
    </tr>
</script>


<script id="tpl_combo_vectors" type="text/template">
<!
    var vectors = getVectors();
    for(var i = 0; i < vectors.length; i++) { !>
    <li><a href="#" value="<!= vectors[i] !>"><!= vectors[i] !></a></li>
<! } !>
</script>

</body>
</html>