<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="../../../lib/jquery-1.11.0.min.js"></script>
    <script src="jui.chart.min.js"></script>
    <script src="finger.js"></script>
    <script>
        jui.define("chart.brush.egg", [], function() {
            var EggBrush = function() {
                this.draw = function() {
                    var g = this.chart.svg.group();
                    this.eachData(function(i, data) {
                        var c = this.chart.svg.circle({
                            id: 'egg' + i,
                            fill: data.color,
                            r: data.r,
                            cx : data.x,
                            cy : data.y,
                            cursor: "pointer"
                        });
                        this.addEvent(c, i, 0);
                        g.append(c);
                    });
                    return g;
                }
            }

            return EggBrush;
        }, "chart.brush.core");


        jui.ready(["chart.builder", "util.math" ], function(builder, _) {

            /* ------------------------------------------------------------------------------------------------ */

            var domain = [ -20, 20 ];
            var chartWidth = 750;
            var chartHeight = 750;
            var data = []; //공의데이터

            initEgg();

            //초기화
            function initEgg(){

                var eggNum = 1;
                var flag = false;

                for(var i=0; i<eggNum; i++){

                    var obj = {};
                    obj.color   = '#' + Math.floor(Math.random()*16777215).toString(16);
                    obj.x       = 200; //임의의 x
                    obj.y       = 200; //임의의 y
                    obj.r       = 20; //원의 반지름
                    obj.mass    = obj.r; //질량(운동량을 계산하기 위해서는 물체의 질량이 필요함)
                    //obj.angle   = Math.floor(Math.random()*360); //알의각도
                    obj.angle   = 0; //알의각도
                    obj.speed   = 0; //알의 속도
                    obj.vx      = 0; //x축 속력
                    obj.vy      = 0; //x축 속력

                    data.push(obj);

                }
            };


            /* ------------------------------------------------------------------------------------------------ */


            var c = builder("#chart", {
                theme: "dark",
                padding: { top: 40, bottom: 20, left: 20, right: 20 },
                width: chartWidth,
                height: chartHeight,
                axis: [{
                    x: { type: "range", domain: domain, unit: 1, line: "solid" },
                    y: { type: "range", domain: domain, unit: 1, line: "solid" },
                    data: data
                }],
                brush: [{
                    type: "egg"
                }],
                widget: [{
                    type: "finger"
                }],
                style: {
                    gridXAxisBorderWidth: 1, gridYAxisBorderWidth: 1, gridTickBorderSize: 0, gridXFontSize: 9, gridYFontSize: 9
                },
                event: {
                    "finger.hit": function(index, degree, percent, line) {

                        var maxSpeed    = 10;
                        var speed       = maxSpeed * (percent / 100);
                        var d           = data[index];
                        var friction    = .02;  //마찰력
                        var framerate   = 1000/30;

                        window.time        = null;

                        //슈팅한 공의 속도 저장
                        d.speed = speed;

                        // [ 벡터이동 ]
                        // 조준을 통해 얻어진 각도를 이용하여 x, y의 진행방향을 결정하고 속도(힘)을 곱하여 움직임을 정한다.
                        for(var i=0; i<data.length;i++){
                            data[i].vx = Math.cos(_.radian(degree)) * data[i].speed;
                            data[i].vy = Math.sin(_.radian(degree)) * data[i].speed;
                        }

                        line.attr({
                            stroke : d.color
                        });


                        time = setInterval(moveEgg, framerate);

                        /* 공 움직이기 */
                        function moveEgg(){

                            var egg;

                            for(var i=0;i<data.length;i++){
                                egg = data[i];

                                // [ 등속운동과 마찰력 ]
                                // 외력이 작용받지 않는 물체는 등속운동이 지속 되므로 표면상에서 운동이 된다는 가정하에 마찰력을 적용하여 감속시킨다.
                                // http://www.scienceall.com/%EB%93%B1%EC%86%8D%EC%9A%B4%EB%8F%99uniform-motion/

                                // interval 마다 감산되여 결국엔 속도가 0이 되도록한다.
                                egg.vx = egg.vx - (egg.vx * friction);
                                egg.vy = egg.vy - (egg.vy * friction);

                                egg.x += egg.vx;
                                egg.y += egg.vy;
                            }

                            c.axis(0).update(data);
                        }

                    }
                }
            });
        });
    </script>

</head>

<body>
    <div id="chart"></div>
    <d id="result"></d>
</body>
</html>